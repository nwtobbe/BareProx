@model BareProx.Models.NetappControllerTreeDto

@if (Model == null || Model.Svms == null || !Model.Svms.Any())
{
    <div class="alert alert-warning">No volumes found for this controller.</div>
}
else
{
    <ul class="list-group">
        <li class="list-group-item active fw-bold">
            @Model.ControllerName
        </li>

        @for (int i = 0; i < Model.Svms.Count; i++)
        {
            var svm = Model.Svms[i];
            var collapseId = $"collapse-svm-{i}";
            var hasSelected = svm.Volumes?.Any(v => v.IsSelected) == true;   // auto-open if something is selected
            var selectedCount = svm.Volumes?.Count(v => v.IsSelected) ?? 0;
            var totalCount = svm.Volumes?.Count ?? 0;

            <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>@svm.Name</strong>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-secondary" title="Selected / Total">@selectedCount / @totalCount</span>
                        <button class="btn btn-sm btn-outline-secondary"
                                type="button"
                                data-bs-toggle="collapse"
                                data-bs-target="#@collapseId"
                                aria-expanded="@(hasSelected.ToString().ToLower())"
                                aria-controls="@collapseId">
                            Toggle Volumes
                        </button>
                    </div>
                </div>

                <div class="collapse mt-2 @(hasSelected ? "show" : "")" id="@collapseId">
                    <ul class="list-group">
                        @if (svm.Volumes != null)
                        {
                            @foreach (var vol in svm.Volumes)
                            {
                                var inputId = $"chk-{i}-{System.Web.HttpUtility.HtmlAttributeEncode(vol.Uuid ?? vol.VolumeName)}";

                                <li class="list-group-item d-flex align-items-center">
                                    <input type="checkbox"
                                           id="@inputId"
                                           class="volume-checkbox form-check-input me-2"
                                           data-vserver="@svm.Name"
                                           data-volume="@vol.VolumeName"
                                           data-uuid="@vol.Uuid"
                                           data-mountip="@vol.MountIp"
                                           data-clusterid="@vol.ClusterId"
                                           @(vol.IsSelected ? "checked=\"checked\"" : null) />
                                    <label class="form-check-label mb-0" for="@inputId">
                                        @vol.VolumeName
                                        @if (!string.IsNullOrWhiteSpace(vol.MountIp))
                                        {
                                            <small class="text-muted">(@vol.MountIp)</small>
                                        }
                                    </label>
                                </li>
                            }
                        }
                    </ul>
                </div>
            </li>
        }
    </ul>
}
