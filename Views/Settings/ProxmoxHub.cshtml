@using BareProx.Models
@model ProxmoxHubViewModel

@{
    ViewData["Title"] = "Proxmox – Clusters";
    var hasSelection = Model.SelectedCluster != null;

    var clusterCount = Model.Clusters?.Count() ?? 0;
    var allowAddCluster = clusterCount == 0; // single-cluster mode
}

<style>
    #clusterTable tbody tr.cluster-row {
        cursor: pointer;
    }

        #clusterTable tbody tr.cluster-row:hover {
            background-color: rgba(0,0,0,.03);
        }

    /* Wizard/log styling */
    #clusterDiscoveryLog {
        font-family: monospace;
        font-size: .8rem;
        background: #111;
        color: #eee;
        padding: .5rem .75rem;
        border-radius: .35rem;
        max-height: 220px;
        overflow-y: auto;
        white-space: pre-wrap;
    }

    .wizard-step {
        display: none;
    }

        .wizard-step.active {
            display: block;
        }

    .small-input {
        max-width: 220px;
    }
</style>

<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Proxmox – Clusters</h2>
    <span class="text-muted">@clusterCount total (single-cluster mode)</span>
</div>

@if (!string.IsNullOrWhiteSpace(Model.Message))
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @Model.Message
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (clusterCount > 1)
{
    <div class="alert alert-warning" role="alert">
        You have <strong>@clusterCount</strong> clusters configured. Only <strong>one</strong> Proxmox cluster is supported.
        Please delete the extra clusters and keep a single one.
        <br />
        <strong>Warning:</strong> Deleting a cluster will break relationships if backups, schedules, or mappings exist.
    </div>
}

<ul class="nav nav-tabs" id="hubTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link active" id="tab-clusters"
           href="@Url.Action("ProxmoxHub", "Settings")" role="tab">
            Clusters
        </a>
    </li>

    <li class="nav-item @(hasSelection ? "" : "d-none")" role="presentation" id="nav-edit-hosts">
        <button class="nav-link" id="tab-edit" data-bs-toggle="tab" data-bs-target="#pane-edit" type="button" role="tab">
            Edit & Hosts
        </button>
    </li>
    <li class="nav-item @(hasSelection ? "" : "d-none")" role="presentation" id="nav-storage">
        <button class="nav-link" id="tab-storage" data-bs-toggle="tab" data-bs-target="#pane-storage" type="button" role="tab">
            Storage
        </button>
    </li>
</ul>

<div class="tab-content pt-3">
    <!-- TAB 1: Clusters (list + add/wizard) -->
    <div class="tab-pane fade show active" id="pane-clusters" role="tabpanel" aria-labelledby="tab-clusters">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="text-muted small">
                Define your Proxmox cluster here.
            </div>
            <div>
                @if (allowAddCluster)
                {
                    <button type="button"
                            class="btn btn-success btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#clusterWizardModal">
                        Discover &amp; Add Cluster
                    </button>
                    <a href="#" class="btn btn-outline-secondary btn-sm ms-2"
                       data-bs-toggle="collapse" data-bs-target="#manualClusterCollapse">
                        Manual Add
                    </a>
                }
                else
                {
                    <button class="btn btn-secondary btn-sm" disabled>
                        Cluster already configured
                    </button>
                }
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle" id="clusterTable">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Last Checked</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var c in Model.Clusters ?? Enumerable.Empty<ProxmoxCluster>())
                    {
                        var status = string.IsNullOrWhiteSpace(c.LastStatus) ? "Unknown" : c.LastStatus;
                        var badge =
                        status.Equals("working", StringComparison.OrdinalIgnoreCase) ? "success" :
                        status.Equals("configured", StringComparison.OrdinalIgnoreCase) ? "info" :
                        "secondary";

                        var editUrl = Url.Action("ProxmoxHub", "Settings", new { selectedId = c.Id, tab = "edit" }) + "#pane-edit";
                        var storageUrl = Url.Action("ProxmoxHub", "Settings", new { selectedId = c.Id, tab = "storage" }) + "#pane-storage";

                        <tr class="cluster-row"
                            data-selected-id="@c.Id"
                            data-edit-url="@editUrl"
                            data-storage-url="@storageUrl">
                            <td>
                                <div class="fw-semibold">@c.Name</div>
                                <div class="small text-muted">ID: @c.Id</div>
                                <div class="small">
                                    <a href="@storageUrl" class="link-secondary row-storage-link">Storage</a>
                                </div>
                            </td>
                            <td><span class="badge bg-@badge text-uppercase">@status</span></td>
                            <td>
                                @if (c.LastChecked.HasValue)
                                {
                                    @c.LastChecked.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </td>
                            <td class="text-end">
                                <div class="btn-group">
                                    <form asp-controller="Settings" asp-action="AuthenticateCluster" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@c.Id" />
                                        <button type="submit" class="btn btn-outline-primary btn-sm">Authenticate</button>
                                    </form>

                                    <form asp-controller="Settings" asp-action="DeleteCluster" method="post" class="d-inline"
                                          onsubmit="return confirm('Delete cluster “@c.Name”?');">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@c.Id" />
                                        <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Manual fallback form (hidden by default) -->
        <div id="manualClusterCollapse" class="collapse mt-4">
            <div class="card">
                <div class="card-header">Manual Cluster Definition</div>
                <div class="card-body">
                    <form asp-controller="Settings" asp-action="AddCluster" method="post" class="row g-3">
                        @Html.AntiForgeryToken()
                        <div class="col-md-4">
                            <label for="Name" class="form-label">Cluster Name</label>
                            <input type="text" name="Name" id="Name" class="form-control" required maxlength="64" />
                        </div>
                        <div class="col-md-4">
                            <label for="Username" class="form-label">API Username</label>
                            <input type="text" name="Username" id="Username" class="form-control" placeholder="root@pam" required />
                        </div>
                        <div class="col-md-4">
                            <label for="Password" class="form-label">API Password</label>
                            <input type="password" name="Password" id="Password" class="form-control" autocomplete="new-password" required />
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-success">Add Cluster (Manual)</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: Edit & Hosts -->
    <div class="tab-pane fade" id="pane-edit" role="tabpanel" aria-labelledby="tab-edit">
        @if (!(Model.SelectedCluster is ProxmoxCluster m))
        {
            <div class="alert alert-secondary">Select a cluster (click a row) to manage it.</div>
        }
        else
        {
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">Cluster Settings — @m.Name</div>
                        <div class="card-body">
                            <form asp-action="EditCluster" asp-controller="Settings" method="post">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="Id" value="@m.Id" />

                                <div class="mb-3">
                                    <label class="form-label">Cluster Name</label>
                                    <input name="Name" class="form-control" value="@m.Name" maxlength="64" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">API Username</label>
                                    <input name="Username" class="form-control" value="@m.Username" placeholder="root@pam" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">API Password</label>
                                    <input name="PasswordHash" type="password" class="form-control" autocomplete="new-password" placeholder="••••••••" />
                                    <div class="form-text">Leave blank to keep the current password.</div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">Save</button>
                                    <a asp-action="ProxmoxHub" asp-controller="Settings" class="btn btn-secondary">Cancel</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            Hosts in “@m.Name”
                            <span class="text-muted">(@(m.Hosts?.Count() ?? 0))</span>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Management IP / FQDN</th>
                                            <th>Proxmox Hostname</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var h in m.Hosts ?? Enumerable.Empty<ProxmoxHost>())
                                        {
                                            <tr>
                                                <td>@h.HostAddress</td>
                                                <td>@h.Hostname</td>
                                                <td class="text-end">
                                                    <form asp-action="DeleteHost" asp-controller="Settings" method="post" class="d-inline"
                                                          onsubmit="return confirm('Remove host @h.Hostname?');">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="id" value="@h.Id" />
                                                        <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                                                    </form>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            <hr />
                            <form asp-action="AddHost" asp-controller="Settings" method="post" class="row g-3">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="clusterId" value="@m.Id" />
                                <div class="col-md-6">
                                    <label class="form-label">Management IP / FQDN</label>
                                    <input type="text" name="hostAddress" class="form-control" required />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Hostname in Proxmox</label>
                                    <input type="text" name="hostname" class="form-control" required />
                                </div>
                                <div class="col-12">
                                    <button type="submit" class="btn btn-success">Add Host</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- TAB 3: Storage -->
    <div class="tab-pane fade" id="pane-storage" role="tabpanel" aria-labelledby="tab-storage">
        @if (!hasSelection || Model.StorageView == null)
        {
            <div class="alert alert-secondary">Select a cluster (click a row) to load storage.</div>
        }
        else
        {
            var sv = Model.StorageView;
            <form asp-controller="Settings" asp-action="SaveSelectedStorage" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="ClusterId" value="@sv!.ClusterId" />

                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-6">
                                <label class="form-label">Search</label>
                                <input id="storageSearch" type="text" class="form-control" placeholder="Filter by storage/path/node..." />
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-outline-secondary btn-sm" type="button" id="clearSearch">Clear</button>
                            </div>
                        </div>
                        <div class="mt-2 small text-muted">
                            <span id="selectedCount">0</span> selected
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mb-2">
                    <button class="btn btn-sm btn-outline-primary" type="button" id="selectAllVisible">Select all (visible)</button>
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="clearAll">Clear all</button>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped align-middle" id="storageTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width:6%">Select</th>
                                <th style="width:24%">Storage</th>
                                <th style="width:10%">Type</th>
                                <th>Path</th>
                                <th style="width:16%">Node</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < sv.StorageList.Count; i++)
                            {
                                var s = sv.StorageList[i];
                                var isNfs = string.Equals(s.Type, "nfs", StringComparison.OrdinalIgnoreCase);
                                <tr data-storage="@s.Storage.ToLowerInvariant()"
                                    data-type="@s.Type.ToLowerInvariant()"
                                    data-path="@s.Path.ToLowerInvariant()"
                                    data-node="@s.Node.ToLowerInvariant()">
                                    <td>
                                        <input type="checkbox"
                                               name="SelectedStorageIds"
                                               value="@s.Id"
                                               class="selBox"
                                               @(s.IsSelected ? "checked" : "") />
                                    </td>
                                    <td class="fw-semibold">@s.Storage</td>
                                    <td><span class="badge bg-@(isNfs ? "info" : "secondary") text-uppercase">@s.Type</span></td>
                                    <td><code>@s.Path</code></td>
                                    <td>@s.Node</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button type="submit" class="btn btn-success">Save Selected</button>
                </div>
            </form>
        }
    </div>
</div>

@* ========== Cluster Discovery Wizard Modal ========== *@
<div class="modal fade" id="clusterWizardModal" tabindex="-1" aria-labelledby="clusterWizardLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clusterWizardLabel">Discover &amp; Add Proxmox Cluster</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                <!-- Step 1: Seed host + credentials -->
                <div class="wizard-step active" id="wizard-step-1">
                    <p class="small text-muted mb-3">
                        Please provide information for one node from your Proxmox cluster.
                    </p>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Seed host (IP / FQDN)</label>
                            <input type="text" class="form-control" id="wizSeedHost" placeholder="10.x.x.x or proxnode1.local" required />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">SSH / API Username</label>
                            <input type="text" class="form-control" id="wizUsername" value="root@pam" required />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="wizPassword" autocomplete="new-password" required />
                        </div>
                    </div>
                </div>

                <!-- Step 2: Discovery log -->
                <div class="wizard-step" id="wizard-step-2">
                    <p class="small text-muted mb-2">
                        Running discovery… resolving IPs, probing SSH.
                    </p>
                    <div id="clusterDiscoveryLog"></div>
                </div>

                <!-- Step 3: Summary + editable nodes -->
                <div class="wizard-step" id="wizard-step-3">
                    <div class="mb-3">
                        <label class="form-label">Cluster Name</label>
                        <input type="text" class="form-control" id="wizClusterName" readonly />
                        <div class="form-text">
                            Detected from Proxmox. You can adjust later under “Edit &amp; Hosts” if needed.
                        </div>
                    </div>

                    <div class="table-responsive mb-2">
                        <table class="table table-sm align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Use</th>
                                    <th>Nodes</th>
                                    <th>IP Address</th>
                                    <th>Fqdn (Clear to use IP)</th>
                                    <th>SSH OK</th>
                                </tr>
                            </thead>
                            <tbody id="wizNodesBody">
                                @* filled by JS *@
                            </tbody>
                        </table>
                    </div>
                    <p class="small text-muted">
                        Tweak IP/hostname mappings if needed. Only checked nodes will be added as BareProx hosts.
                    </p>
                    <div class="alert alert-danger d-none" id="wizErrorSummary"></div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" id="wizPrev" class="btn btn-outline-secondary d-none">Back</button>
                <button type="button" id="wizNext" class="btn btn-primary">Next</button>
                <button type="button" id="wizSave" class="btn btn-success d-none">Save Cluster</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            const showTab = (btnSel) => {
                const btn = document.querySelector(btnSel);
                if (btn && typeof bootstrap !== 'undefined') new bootstrap.Tab(btn).show();
            };

            const hasSelection = @hasSelection.ToString().ToLower();

            if (hasSelection) {
                document.getElementById('nav-edit-hosts')?.classList.remove('d-none');
                document.getElementById('nav-storage')?.classList.remove('d-none');

                if (tab === 'edit') showTab('#tab-edit');
                if (tab === 'storage') showTab('#tab-storage');
                if (location.hash === '#pane-edit') showTab('#tab-edit');
                if (location.hash === '#pane-storage') showTab('#tab-storage');
            }

            // Cluster row click => open Edit tab for that cluster
            document.querySelectorAll('#clusterTable tbody tr.cluster-row').forEach(tr => {
                tr.addEventListener('click', function (e) {
                    if (e.target.closest('form') || e.target.closest('.btn') || e.target.closest('a.row-storage-link')) return;
                    const url = this.getAttribute('data-edit-url');
                    if (url) window.location = url;
                });
            });

            // ===== Storage search + select helpers =====
            (function () {
                const tb = document.getElementById('storageTable');
                if (!tb) return;

                const q = document.getElementById('storageSearch');
                const btnClear = document.getElementById('clearSearch');
                const btnAll = document.getElementById('selectAllVisible');
                const btnNone = document.getElementById('clearAll');
                const selectedCount = document.getElementById('selectedCount');

                function updateSelectedCount() {
                    if (!selectedCount) return;
                    selectedCount.textContent = tb.querySelectorAll('tbody input.selBox:checked').length;
                }

                function applyFilters() {
                    const qq = (q?.value || '').toLowerCase();
                    tb.querySelectorAll('tbody tr').forEach(tr => {
                        const storage = tr.getAttribute('data-storage') || '';
                        const path = tr.getAttribute('data-path') || '';
                        const node = tr.getAttribute('data-node') || '';
                        const match = [storage, path, node].some(x => x.indexOf(qq) !== -1);
                        tr.style.display = match ? '' : 'none';
                    });
                }

                function selectAllVisible() {
                    tb.querySelectorAll('tbody tr').forEach(tr => {
                        if (tr.style.display !== 'none') {
                            const cb = tr.querySelector('input.selBox');
                            if (cb) cb.checked = true;
                        }
                    });
                    updateSelectedCount();
                }

                function clearAll() {
                    tb.querySelectorAll('tbody input.selBox').forEach(cb => cb.checked = false);
                    updateSelectedCount();
                }

                q?.addEventListener('input', applyFilters);
                btnClear?.addEventListener('click', () => { if (!q) return; q.value = ''; applyFilters(); });
                btnAll?.addEventListener('click', selectAllVisible);
                btnNone?.addEventListener('click', clearAll);
                tb.addEventListener('change', e => {
                    if (e.target && e.target.classList.contains('selBox')) updateSelectedCount();
                });

                applyFilters();
                updateSelectedCount();
            })();

        // ===== Cluster Discovery Wizard (async with live logs) =====
        const modalEl = document.getElementById('clusterWizardModal');
        if (!modalEl) return;
        const modal = new bootstrap.Modal(modalEl);

        const step1 = document.getElementById('wizard-step-1');
        const step2 = document.getElementById('wizard-step-2');
        const step3 = document.getElementById('wizard-step-3');

        const btnPrev = document.getElementById('wizPrev');
        const btnNext = document.getElementById('wizNext');
        const btnSave = document.getElementById('wizSave');

        const seedHost = document.getElementById('wizSeedHost');
        const username = document.getElementById('wizUsername');
        const password = document.getElementById('wizPassword');
        const logBox = document.getElementById('clusterDiscoveryLog');
        const clusterNameInput = document.getElementById('wizClusterName');
        const nodesBody = document.getElementById('wizNodesBody');
        const errorSummary = document.getElementById('wizErrorSummary');

        // Correct endpoints
        const startUrl = '@Url.Action("StartProxmoxDiscovery", "Settings")';
        const statusUrl = '@Url.Action("GetProxmoxDiscoveryStatus", "Settings")';

        let discoveryId = null;
        let lastLogCount = 0;
        let pollTimer = null;
        let discoveryResult = null;

        function setStep(n) {
            [step1, step2, step3].forEach((s, i) => {
                s.classList.toggle('active', i === (n - 1));
            });
            btnPrev.classList.toggle('d-none', n === 1);
            btnNext.classList.toggle('d-none', n !== 1);
            btnSave.classList.toggle('d-none', n !== 3);
            errorSummary.classList.add('d-none');
            errorSummary.textContent = '';
        }

        function appendLog(line) {
            if (!logBox) return;
            logBox.textContent += line + "\n";
            logBox.scrollTop = logBox.scrollHeight;
        }

        async function pollDiscovery() {
            if (!discoveryId) return;

            try {
                const resp = await fetch(statusUrl + '?id=' + encodeURIComponent(discoveryId));
                if (!resp.ok) {
                    appendLog("Polling failed with HTTP " + resp.status);
                    clearInterval(pollTimer);
                    pollTimer = null;
                    setStep(1);
                    return;
                }

                const data = await resp.json();

                // Append any new logs
                const logs = data.logs || [];
                for (let i = lastLogCount; i < logs.length; i++) {
                    appendLog(logs[i]);
                }
                lastLogCount = logs.length;

                // If not completed yet, just keep polling
                if (!data.completed) {
                    return;
                }

                // Completed → stop polling
                clearInterval(pollTimer);
                pollTimer = null;
                discoveryId = null;

                // On completion, success MUST be true; otherwise it's a failure
                if (!data.success) {
                    appendLog("Discovery failed: " + (data.error || "Unknown error"));
                    alert("Discovery failed: " + (data.error || "Unknown error"));
                    setStep(1);
                    return;
                }

                if (!data.result || !data.result.nodes || !data.result.nodes.length) {
                    appendLog("Discovery returned no nodes.");
                    alert("Discovery returned no nodes.");
                    setStep(1);
                    return;
                }

                // Success → build step 3 UI
                discoveryResult = data.result;
                setStep(3);

                clusterNameInput.value = discoveryResult.clusterName || "";
                clusterNameInput.readOnly = true;

                nodesBody.innerHTML = "";
                const nodes = (discoveryResult.nodes || [])
                    .slice()
                    .sort((a, b) =>
                        (a.nodeName || '').localeCompare(b.nodeName || '', undefined, { sensitivity: 'base' })
                    );

                nodes.forEach((n, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <input type="checkbox" class="form-check-input wiz-node-use" checked data-index="${idx}" />
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm small-input wiz-node-name"
                                   value="${n.nodeName || ""}" data-index="${idx}" />
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm small-input wiz-node-ip"
                                   value="${n.ip || ""}" data-index="${idx}" />
                        </td>
                        <td>
                            <input type="text" class="form-control form-control-sm wiz-node-host"
                                   value="${n.reverseName || ""}" placeholder="optional" data-index="${idx}" />
                        </td>
                        <td>
                            <span class="badge ${n.sshOk ? "bg-success" : "bg-warning"}">
                                ${n.sshOk ? "OK" : "Check"}
                            </span>
                        </td>
                    `;
                    nodesBody.appendChild(tr);
                });

            } catch (e) {
                appendLog("Polling exception: " + e);
                clearInterval(pollTimer);
                pollTimer = null;
                setStep(1);
            }
        }

        btnNext.addEventListener('click', async function () {
            if (!seedHost.value || !username.value || !password.value) {
                alert("Please fill in seed host, username and password.");
                return;
            }

            setStep(2);
            logBox.textContent = "";
            appendLog("Connecting to seed host " + seedHost.value + " ...");

            lastLogCount = 0;
            discoveryId = null;
            discoveryResult = null;
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }

            try {
                const resp = await fetch(startUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        seedHost: seedHost.value,
                        username: username.value,
                        password: password.value
                    })
                });

                if (!resp.ok) {
                    appendLog("Discovery failed with HTTP " + resp.status);
                    alert("Discovery failed. Check logs and credentials.");
                    setStep(1);
                    return;
                }

                const data = await resp.json();

                if (data.success === false) {
                    appendLog("Failed to start discovery: " + (data.error || "Unknown error"));
                    alert("Failed to start discovery: " + (data.error || "Unknown error"));
                    setStep(1);
                    return;
                }

                if (!data.id) {
                    appendLog("Failed to start discovery: missing id");
                    alert("Failed to start discovery: missing id.");
                    setStep(1);
                    return;
                }

                discoveryId = data.id;
                pollTimer = setInterval(pollDiscovery, 1000);
            } catch (e) {
                appendLog("Discovery start exception: " + e);
                alert("Discovery failed: " + e);
                setStep(1);
            }
        });

        btnPrev.addEventListener('click', function () {
            setStep(1);
        });

        btnSave.addEventListener('click', async function () {
            if (!discoveryResult) return;

            const clusterName = (clusterNameInput.value || "").trim();
            if (!clusterName) {
                errorSummary.textContent = "Cluster name is required.";
                errorSummary.classList.remove('d-none');
                return;
            }

            const rows = nodesBody.querySelectorAll('tr');
            const nodes = [];
            rows.forEach(tr => {
                const useCb = tr.querySelector('.wiz-node-use');
                if (!useCb || !useCb.checked) return;

                const name = tr.querySelector('.wiz-node-name')?.value?.trim();
                const ip = tr.querySelector('.wiz-node-ip')?.value?.trim();
                const host = tr.querySelector('.wiz-node-host')?.value?.trim();

                if (!name || !ip) return;

                nodes.push({
                    nodeName: name,
                    ip: ip,
                    hostAddress: host || ip
                });
            });

            if (nodes.length === 0) {
                errorSummary.textContent = "Select at least one node to add.";
                errorSummary.classList.remove('d-none');
                return;
            }

            try {
                const resp = await fetch('@Url.Action("CreateClusterFromDiscovery", "Settings")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        clusterName: clusterName,
                        username: username.value,
                        password: password.value,
                        nodes: nodes
                    })
                });

        if (!resp.ok) {
            const txt = await resp.text();
            errorSummary.textContent = "Failed to save cluster: " + txt;
            errorSummary.classList.remove('d-none');
            return;
        }

        const data = await resp.json();
        if (!data || !data.clusterId) {
            errorSummary.textContent = "Cluster saved but response was missing cluster id.";
            errorSummary.classList.remove('d-none');
            return;
        }

        // 🔽 Jump straight to Storage tab for the new cluster
        window.location = '@Url.Action("ProxmoxHub", "Settings")'
            + '?selectedId=' + encodeURIComponent(data.clusterId)
            + '&tab=storage#pane-storage';

            } catch (e) {
                errorSummary.textContent = "Error saving cluster: " + e;
                errorSummary.classList.remove('d-none');
            }
        });

        // Reset wizard on open
        modalEl.addEventListener('show.bs.modal', function () {
            setStep(1);
            seedHost.value = "";
            username.value = "root@pam";
            password.value = "";
            logBox.textContent = "";
            nodesBody.innerHTML = "";
            discoveryResult = null;
            discoveryId = null;
            lastLogCount = 0;
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
        });

        });
    </script>
}
