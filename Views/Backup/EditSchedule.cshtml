@model CreateScheduleRequest
@using System.Text.Json
@using System.Linq

@{
    ViewData["Title"] = "Edit Backup Schedule";

    // Slim JSON for client (value/text/selected) keyed by storage
    var vmsByStorageSlim = (Model.VmsByStorage ?? new Dictionary<string, List<SelectListItem>>())
        .ToDictionary(
            kv => kv.Key,
            kv => kv.Value.Select(v => new { value = v.Value, text = v.Text, selected = v.Selected }).ToList()
        );
    var preselectedExcluded = Model.ExcludedVmIds ?? new List<string>();
}

<div class="mb-3 d-flex justify-content-between align-items-center">
    <h4 class="mb-0">Edit Backup Schedule</h4>
    <a asp-action="Backup" asp-controller="Backup" class="btn btn-secondary">← Back to Schedules</a>
</div>

<form asp-action="EditSchedule"
      method="post"
      class="needs-validation"
      novalidate="novalidate">
    <input type="hidden" asp-for="Id" />

    <!-- Name -->
    <div class="mb-3">
        <label asp-for="Name" class="form-label">Backup Schedule Name</label>
        <input asp-for="Name"
               class="form-control"
               maxlength="20"
               pattern="^[A-Za-z0-9_\-]+$"
               title="Only letters, numbers, hyphens and underscores (max 20 chars)."
               oninput="validateScheduleName(this)"
               required />
        <div class="invalid-feedback">
            Only letters, numbers, hyphens and underscores are allowed (max 20 characters).
        </div>
    </div>

    <!-- Enabled -->
    <div class="mb-3 form-check">
        <input class="form-check-input" asp-for="IsEnabled" />
        <label class="form-check-label" asp-for="IsEnabled">Schedule Enabled</label>
    </div>

    <!-- Storage (locked for edit) -->
    <div class="mb-3">
        <label class="form-label">Storage</label>
        <select asp-for="StorageName"
                class="form-select"
                asp-items="Model.StorageOptions"
                disabled
                required>
            <option value="">-- Select Storage --</option>
        </select>
        <input type="hidden" name="StorageName" value="@Model.StorageName" />
        <div class="invalid-feedback">Please select a storage.</div>
    </div>
    <input type="hidden" asp-for="ClusterId" id="ClusterId" />
    <input type="hidden" asp-for="ControllerId" id="ControllerId" />

    <!-- Backup Type -->
    <div class="mb-3">
        <label class="form-label">Backup Type</label><br />
        <div class="form-check form-check-inline">
            <input asp-for="IsApplicationAware"
                   class="form-check-input"
                   type="radio"
                   id="ccRadio"
                   value="false" />
            <label class="form-check-label" for="ccRadio">Crash-Consistent</label>
        </div>
        <div class="form-check form-check-inline">
            <input asp-for="IsApplicationAware"
                   class="form-check-input"
                   type="radio"
                   id="aaRadio"
                   value="true" />
            <label class="form-check-label" for="aaRadio">With Proxmox options</label>
        </div>
    </div>

    <!-- App-Aware Options -->
    <div id="appAwareOptions" class="border rounded p-3 bg-light d-none">
        <div class="form-check">
            <input class="form-check-input"
                   type="checkbox"
                   asp-for="EnableIoFreeze"
                   id="EnableIoFreeze" />
            <label class="form-check-label" for="EnableIoFreeze">Enable IO-Freeze</label>
        </div>
        <div class="form-check">
            <input class="form-check-input"
                   type="checkbox"
                   asp-for="UseProxmoxSnapshot"
                   id="UseProxmoxSnapshot" />
            <label class="form-check-label" for="UseProxmoxSnapshot">Create Snapshot</label>
        </div>
        <div id="appAwareError" class="text-danger mt-2" style="display:none;">
            You must choose either IO-Freeze OR Proxmox Snapshot.
        </div>
        <div id="proxmoxSnapshotOptions" class="mt-2 ms-3 d-none">
            <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       asp-for="WithMemory"
                       id="WithMemory" />
                <label class="form-check-label" for="WithMemory">Include RAM (With Memory)</label>
            </div>
        </div>
    </div>

    <hr />

    <!-- Schedule Type -->
    <div class="mb-3">
        <label class="form-label">Schedule Type</label>
        <select asp-for="SingleSchedule.Type"
                id="scheduleTypeSelect"
                class="form-select"
                required>
            <option value="">-- Select Type --</option>
            <option value="Hourly">Hourly</option>
            <option value="Daily">Daily</option>
            <option value="Weekly">Weekly</option>
        </select>
        <div class="invalid-feedback">Please select a schedule type.</div>
    </div>

    <!-- Dynamic schedule fields -->
    <div id="single-schedule-fields"></div>
    <input type="hidden" asp-for="SingleSchedule.Label" id="snapmirrorLabel" />

    <!-- Retention -->
    <div class="mb-3">
        <label class="form-label">Retention</label>
        <div class="input-group">
            <select asp-for="SingleSchedule.RetentionUnit" class="form-select" required id="RetentionUnit">
                <option value="Hours">Hours</option>
                <option value="Days">Days</option>
                <option value="Weeks">Weeks</option>
            </select>
            <input asp-for="SingleSchedule.RetentionCount"
                   type="number"
                   min="1" max="256"
                   class="form-control"
                   id="RetentionCount"
                   required />
            <div class="invalid-feedback">
                Enter a number between 1 and 256.
            </div>
        </div>
    </div>

    <input type="hidden"
           id="replicableVolumes"
           value="@string.Join(',', Model.ReplicableVolumes ?? new HashSet<string>())" />

    <!-- Locking -->
    <div class="mb-3 form-check d-none" id="lockingCheckbox">
        <input class="form-check-input"
               type="checkbox"
               asp-for="EnableLocking"
               id="EnableLocking"
               value="true" />
        <label class="form-check-label" for="EnableLocking">
            Enable Locking
        </label>
    </div>
    <div class="mb-3 d-none" id="lockingRetention">
        <label class="form-label">Locked for:</label>
        <div class="input-group">
            <input type="number"
                   class="form-control"
                   asp-for="LockRetentionCount"
                   id="LockRetentionCount"
                   min="1" max="30"
                   value="@Model.LockRetentionCount" />
            <select class="form-select"
                    asp-for="LockRetentionUnit"
                    id="LockRetentionUnit">
                <option value="Hours">Hours</option>
                <option value="Days">Days</option>
                <option value="Weeks">Weeks</option>
            </select>
        </div>
        <small class="form-text text-muted">
            Must be strictly less than the standard retention (and ≤ 30).
        </small>
    </div>

    <!-- Replicate to Secondary -->
    <div class="mb-3 form-check d-none" id="replicateCheckbox">
        <input class="form-check-input" asp-for="ReplicateToSecondary" id="ReplicateToSecondary" />
        <label class="form-check-label" asp-for="ReplicateToSecondary">Replicate to Secondary</label>
    </div>

    <!-- Exclude VMs (only when App-aware) -->
    <div id="excludeBlock" class="mb-3 d-none" aria-hidden="true">
        <label class="form-label">Exclude VMs</label>

        <div class="d-flex flex-wrap gap-2 mb-2">
            <input type="text" id="exclFilter" class="form-control" placeholder="Filter VMs…" style="max-width: 260px;">
            <div class="btn-group" role="group" aria-label="bulk exclude actions">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="exclAll">Select all</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="exclNone">None</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="exclInvert">Invert</button>
            </div>
            <span class="ms-auto small text-muted" id="exclCount"></span>
        </div>

        <div id="excludeList" class="border rounded p-2" style="max-height: 280px; overflow:auto;"></div>

        <div class="form-text">
            Checked VMs will be <strong>skipped</strong> from Proxmox options. The list reflects this schedule’s storage.
        </div>
    </div>

    <div class="mb-3 text-end">
        <button type="submit" class="btn btn-primary">Update Schedule</button>
        <a asp-action="Backup" asp-controller="Backup" class="btn btn-secondary">Cancel</a>
    </div>
</form>

@section Scripts {
    <script>
        // Server values
        const volumeMeta = @Html.Raw(JsonSerializer.Serialize(Model.VolumeMeta));
        const VMS_BY_STORAGE = @Html.Raw(JsonSerializer.Serialize(vmsByStorageSlim));
        const PRESELECTED_EXCLUDES = @Html.Raw(JsonSerializer.Serialize(preselectedExcluded));

        const initialType = '@Model.SingleSchedule.Type';
        const initialStartHour = '@Model.SingleSchedule.StartHour';
        const initialEndHour = '@Model.SingleSchedule.EndHour';
        const initialTime = '@Model.SingleSchedule.Time';
        const initialDays = @Html.Raw(JsonSerializer.Serialize(Model.SingleSchedule.DaysOfWeek ?? Enumerable.Empty<string>()));

        const enableLockingInitially = @(Model.EnableLocking.ToString().ToLower());
        const initialLockRetentionCount = @(Model.LockRetentionCount ?? 1);
        const initialLockRetentionUnit  = "@(Model.LockRetentionUnit ?? "Hours")";
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function(){
          const form = document.querySelector('form.needs-validation');
          const nameInput = form?.querySelector('input[asp-for="Name"]');

          // Retention inputs
          const retentionEl  = document.getElementById('RetentionCount');
          const retentionUnit= document.getElementById('RetentionUnit');

          // Schedule fields
          const selectType  = document.getElementById('scheduleTypeSelect');

          // App-aware bits
          const ccRadio = document.getElementById('ccRadio');
          const aaRadio = document.getElementById('aaRadio');
          const appOpts = document.getElementById('appAwareOptions');
          const ioFreezeCb = document.getElementById('EnableIoFreeze');
          const proxSnapCb = document.getElementById('UseProxmoxSnapshot');
          const appErr = document.getElementById('appAwareError');
          const proxOpts = document.getElementById('proxmoxSnapshotOptions');
          const withMemory = document.getElementById('WithMemory');

          // Exclude block
          const excludeBlock = document.getElementById('excludeBlock');
          const excludeList  = document.getElementById('excludeList');
          const exclFilter   = document.getElementById('exclFilter');
          const exclCount    = document.getElementById('exclCount');

          // Locking
          const lockingCheckboxContainer  = document.getElementById("lockingCheckbox");
          const lockingCheckbox           = document.getElementById("EnableLocking");
          const lockingRetentionContainer = document.getElementById("lockingRetention");
          const lockCountInput            = document.getElementById("LockRetentionCount");
          const lockUnitSelect            = document.getElementById("LockRetentionUnit");

          // Replication
          const replicateBox = document.getElementById('replicateCheckbox');
          const replicable = (document.getElementById('replicableVolumes')?.value.split(',')||[]).filter(Boolean);

          // Storage (disabled in Edit, but we still use its value)
          const storageSel = form?.querySelector('select[name="StorageName"]');
          const snapLabel  = document.getElementById('snapmirrorLabel');

          // Helpers
          function validateScheduleName(input){ input.value = input.value.replace(/[^A-Za-z0-9_\-]/g,'').slice(0,input.maxLength||20); }
          function blockNonNumeric(e){ if (/[eE+\-.]/.test(e.key)) e.preventDefault(); }
          function clampInput(el){ if(!el) return; el.addEventListener('keydown',blockNonNumeric); el.addEventListener('input',()=>{const min=+el.min,max=+el.max,v=+el.value; if(!isNaN(v)){ if(v<min)el.value=min; if(v>max)el.value=max; } }); }
          nameInput?.addEventListener('keypress', e=>{ if(!/^[A-Za-z0-9_-]$/.test(e.key)) e.preventDefault(); });
          nameInput?.addEventListener('paste', e=>{ e.preventDefault(); const t=(e.clipboardData||window.clipboardData).getData('text/plain').replace(/[^A-Za-z0-9_-]/g,'').slice(0,nameInput.maxLength||20); document.execCommand('insertText',false,t); });
          nameInput?.addEventListener('input', function(){ validateScheduleName(this); });
          clampInput(retentionEl);
          clampInput(lockCountInput);

          // Dynamic schedule fields
          function renderFields(type){
            const c = document.getElementById('single-schedule-fields'); if(!c) return;
            let html='';
            if(type==='Hourly'){
              html += `<div class="mb-3"><label>Start Hour</label>
                       <input type="number" min="0" max="23" step="1" name="SingleSchedule.StartHour" value="${initialStartHour ?? ''}" class="form-control" required />
                       <div class="invalid-feedback">Required</div></div>
                       <div class="mb-3"><label>End Hour</label>
                       <input type="number" min="0" max="23" step="1" name="SingleSchedule.EndHour" value="${initialEndHour ?? ''}" class="form-control" required />
                       <div class="invalid-feedback">Required</div></div>`;
            } else {
              html += '<div class="mb-3"><label>Days</label><div>';
              ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d=>{
                const chk = (initialDays||[]).indexOf(d)!==-1 ? 'checked' : '';
                html += `<label class="me-2"><input type="checkbox" name="SingleSchedule.DaysOfWeek" value="${d}" ${chk}> ${d}</label>`;
              });
              html += `</div><div class="invalid-feedback d-block">Select at least one day.</div></div>
                       <div class="mb-3"><label>Time</label>
                       <input type="time" name="SingleSchedule.Time" value="${initialTime ?? ''}" class="form-control" required />
                       <div class="invalid-feedback">Required</div></div>`;
            }
            c.innerHTML = html;
            if (snapLabel) snapLabel.value = type.toLowerCase();
            c.querySelectorAll('input[type="number"]').forEach(clampInput);
          }
          if (selectType?.value) renderFields(selectType.value);
          selectType?.addEventListener('change', e=>renderFields(e.target.value));

          // Locking UI
          function supportsLocking(volumeName){ return !!(volumeMeta && volumeMeta[volumeName] && volumeMeta[volumeName].SnapshotLockingEnabled); }
          function retentionInHours(count,unit){ const c=+count; if(isNaN(c)||c<1) return 0; return unit==='Hours'?c:unit==='Days'?c*24:unit==='Weeks'?c*168:0; }
          function recalcLockingOptions(){
            if(!lockCountInput || !lockUnitSelect) return;
            const ru = (document.getElementById('RetentionUnit') || document.querySelector('select[name="SingleSchedule.RetentionUnit"]')).value;
            const totalHours = retentionInHours(retentionEl.value, ru);
            if (totalHours <= 1) {
              lockingCheckbox.checked=false; lockingCheckbox.disabled=true; lockingRetentionContainer.classList.add('d-none'); return;
            }
            lockingCheckbox.disabled = false;
            Array.from(lockUnitSelect.options).forEach(opt=>{
              const mul = opt.value==='Days'?24:opt.value==='Weeks'?168:1;
              let maxCnt = Math.floor((totalHours-1)/mul); maxCnt = Math.min(maxCnt,30);
              opt.disabled = maxCnt < 1;
              if (opt.value === lockUnitSelect.value) {
                lockCountInput.max = maxCnt;
                if (+lockCountInput.value > maxCnt) lockCountInput.value = maxCnt;
              }
            });
          }
          function setLockingInputsFromModel(){ if(lockCountInput) lockCountInput.value = initialLockRetentionCount; if(lockUnitSelect) lockUnitSelect.value = initialLockRetentionUnit; }
          function updateLockingUI(){
            const val = storageSel?.value;
            if (!lockingCheckboxContainer || !lockingCheckbox || !lockingRetentionContainer) return;
            if (supportsLocking(val)) {
              lockingCheckboxContainer.classList.remove('d-none');
              lockingCheckbox.disabled = false;
              if (enableLockingInitially || lockingCheckbox.checked) {
                lockingRetentionContainer.classList.remove('d-none');
                setLockingInputsFromModel();
              }
            } else {
              lockingCheckboxContainer.classList.add('d-none');
              lockingCheckbox.checked = false;
              lockingCheckbox.disabled = true;
              lockingRetentionContainer.classList.add('d-none');
            }
            recalcLockingOptions();
          }
          lockingCheckbox?.addEventListener('change', ()=>{ if (lockingCheckbox.checked){ lockingRetentionContainer.classList.remove('d-none'); setLockingInputsFromModel(); recalcLockingOptions(); } else { lockingRetentionContainer.classList.add('d-none'); } });
          retentionEl?.addEventListener('input', recalcLockingOptions);
          retentionUnit?.addEventListener('change', recalcLockingOptions);
          lockUnitSelect?.addEventListener('change', recalcLockingOptions);
          lockCountInput?.addEventListener('input', recalcLockingOptions);

          // Replicate visibility (storage fixed in Edit)
          function toggleReplicateBox(){
            if (!storageSel || !replicateBox) return;
            const val = storageSel.value;
            if ((replicable||[]).indexOf(val) !== -1) replicateBox.classList.remove('d-none');
            else { replicateBox.classList.add('d-none'); replicateBox.querySelector('input')?.removeAttribute('checked'); }
          }

          // Exclude list (only when app-aware)
          const norm = s => (s ?? '').toString().trim().toLowerCase();
          const VMS_KEYS = Object.fromEntries(Object.entries(VMS_BY_STORAGE || {}).map(([k,v]) => [norm(k), v]));

          function renderExcludeListFor(storage){
            const items = VMS_KEYS[norm(storage)] || [];
            if (!items.length){
              excludeList.innerHTML = `<div class="text-muted small p-2">No VMs found for this storage.</div>`;
              if (exclCount) exclCount.textContent = `0/0 selected`;
              return;
            }
            excludeList.innerHTML = items.map(vm=>{
              const isChecked = (PRESELECTED_EXCLUDES||[]).includes(vm.value) || !!vm.selected;
              const label = (vm.text||'');
              const dataLabel = label.toLowerCase().replace(/"/g,'&quot;');
              return `
                <div class="form-check exclude-row" data-label="${dataLabel}">
                  <input class="form-check-input exclude-item" type="checkbox" name="ExcludedVmIds" value="${vm.value}" ${isChecked?'checked':''} />
                  <label class="form-check-label">${label}</label>
                </div>`;
            }).join('');
            applyExcludeFilter(); updateExcludeCount();
            syncExcludeDisabledState(); // reflect current app-aware state
          }
          function applyExcludeFilter(){
            const needle = (exclFilter?.value || '').trim().toLowerCase();
            excludeList.querySelectorAll('.exclude-row').forEach(row=>{
              const label = row.dataset.label || '';
              row.style.display = label.includes(needle) ? '' : 'none';
            });
          }
          function updateExcludeCount(){
            const visible = Array.from(excludeList.querySelectorAll('.exclude-row')).filter(r => r.style.display !== 'none');
            const checked = visible.filter(r => r.querySelector('.exclude-item').checked);
            if (exclCount) exclCount.textContent = `${checked.length}/${visible.length} selected`;
          }
          function setAllVisible(checked){
            excludeList.querySelectorAll('.exclude-row').forEach(row=>{
              if (row.style.display === 'none') return;
              row.querySelector('.exclude-item').checked = checked;
            });
            updateExcludeCount();
          }
          document.getElementById('exclAll')?.addEventListener('click', ()=>setAllVisible(true));
          document.getElementById('exclNone')?.addEventListener('click', ()=>setAllVisible(false));
          document.getElementById('exclInvert')?.addEventListener('click', ()=>{
            excludeList.querySelectorAll('.exclude-row').forEach(row=>{
              if (row.style.display === 'none') return;
              const cb = row.querySelector('.exclude-item'); cb.checked = !cb.checked;
            });
            updateExcludeCount();
          });
          excludeList?.addEventListener('change', e=>{ if (e.target.matches('.exclude-item')) updateExcludeCount(); });
          exclFilter?.addEventListener('input', ()=>{ applyExcludeFilter(); updateExcludeCount(); });

          // App-aware toggle + proxmox snapshot -> with memory UI
          function toggleAppAware(){
            const show = aaRadio?.checked === true;
            appOpts?.classList.toggle('d-none', !show);
            if (!show && ioFreezeCb && proxSnapCb && proxOpts && appErr){
              ioFreezeCb.checked=false; proxSnapCb.checked=false; proxOpts.classList.add('d-none'); withMemory && (withMemory.checked=false); appErr.style.display='none';
            }
            syncExcludeDisabledState();
          }
          function syncExcludeDisabledState(){
            const enabled = aaRadio?.checked === true;
            excludeBlock?.classList.toggle('d-none', !enabled);
            excludeBlock?.setAttribute('aria-hidden', (!enabled).toString());
            Array.from(excludeBlock?.querySelectorAll('input.exclude-item, #exclFilter, #exclAll, #exclNone, #exclInvert') || [])
              .forEach(el => el.disabled = !enabled);
            if (!enabled){
              excludeBlock?.querySelectorAll('input.exclude-item')?.forEach(cb => cb.checked = false);
              if (exclCount) exclCount.textContent = '0/0 selected';
            } else {
              updateExcludeCount();
            }
          }
          // With-memory visibility driven by Proxmox Snapshot
          function syncWithMemory(){
            if (!proxSnapCb || !proxOpts) return;
            if (proxSnapCb.checked) {
              proxOpts.classList.remove('d-none');
            } else {
              proxOpts.classList.add('d-none');
              withMemory && (withMemory.checked = false);
            }
          }
          ccRadio?.addEventListener('change', toggleAppAware);
          aaRadio?.addEventListener('change', toggleAppAware);
          ioFreezeCb?.addEventListener('change', ()=>{ if (ioFreezeCb.checked && proxSnapCb){ proxSnapCb.checked=false; syncWithMemory(); } });
          proxSnapCb?.addEventListener('change', ()=>{ if (proxSnapCb.checked && ioFreezeCb){ ioFreezeCb.checked=false; } syncWithMemory(); });

          // Initial UI sync
          if (selectType?.value) renderFields(selectType.value);
          // Locking / replication (storage fixed)
          (function initLockingReplicateAndIDs(){
            const m = volumeMeta[storageSel?.value] || {};
            document.getElementById('ClusterId').value = m.ClusterId || '';
            document.getElementById('ControllerId').value = m.ControllerId || '';
            updateLockingUI();
            toggleReplicateBox();
          })();

          // Exclude list for this storage & app-aware visibility
          if (storageSel?.value) renderExcludeListFor(storageSel.value);
          toggleAppAware();
          syncWithMemory();

          // Recalc locking on retention unit/count change
          recalcLockingOptions();

          // Submit guard
          form?.addEventListener('submit', function(e){
            if (!form.checkValidity()){ e.preventDefault(); e.stopPropagation(); }
            if (aaRadio?.checked && ioFreezeCb && proxSnapCb && !ioFreezeCb.checked && !proxSnapCb.checked){
              if (appErr) appErr.style.display='block';
              e.preventDefault(); e.stopPropagation();
            }
            // final safety
            syncExcludeDisabledState();
            form.classList.add('was-validated');
          });
        });
    </script>
}
