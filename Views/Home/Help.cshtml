@{
    ViewData["Title"] = "Help & User Guide";
    Layout = "_Layout";
    ViewBag.FullWidth = true; // <-- THIS makes the layout use container-fluid for this page
}

<style>
    /* Two-pane layout */
    .help-wrap {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 1.5rem;
    }

    @@media (max-width: 992px) {
        .help-wrap {
            grid-template-columns: 1fr;
        }

        #help-toc {
            position: static;
            top: auto;
            max-height: none;
        }
    }

    /* TOC */
    #help-toc {
        position: sticky;
        top: 80px; /* adjust if navbar is taller */
        max-height: calc(100vh - 100px);
        overflow: auto;
        padding-right: .5rem;
    }

    .toc-title {
        font-weight: 700;
        margin-bottom: .5rem;
    }

    .toc-list {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

        .toc-list li {
            margin: .25rem 0;
            line-height: 1.3;
        }

    .toc-link {
        text-decoration: none;
        display: inline-block;
        padding: .15rem 0;
    }

        .toc-link.active {
            font-weight: 700;
            text-decoration: underline;
        }

    .toc-depth-3 {
        padding-left: 1rem;
    }

    /* Content cosmetics */
    .help-card {
        border-radius: .75rem;
    }

    .help-content h1 {
        margin-bottom: .75rem;
    }

    .help-content h2 {
        margin-top: 2rem;
        scroll-margin-top: 90px;
    }

    .help-content h3 {
        margin-top: 1.25rem;
        scroll-margin-top: 90px;
    }

    .help-content code {
        white-space: nowrap;
    }

    html {
        scroll-behavior: smooth;
    }
</style>

<div class="mt-4 text-start">
    <!-- text-start ensures left text alignment -->
    <div class="card shadow help-card">
        <div class="card-body">
            <div class="help-wrap">
                <!-- LEFT: Auto TOC -->
                <aside id="help-toc">
                    <div class="toc-title">Contents</div>
                    <ul class="toc-list" id="tocList"></ul>
                    <noscript><small>(Enable JavaScript to see the table of contents.)</small></noscript>
                </aside>

                <!-- RIGHT: Help content -->
                <article class="help-content" id="helpContent">
                    <h1>Help &amp; User Guide</h1>

                    <h2>What is BareProx?</h2>
                    <p>
                        <strong>BareProx</strong> automates VM-safe backups and restores for
                        <em>Proxmox VE</em> environments running on <em>NetApp ONTAP</em> storage (NFS).
                        It coordinates NetApp volume snapshots and FlexClone mounts, can leverage SnapMirror replication,
                        and presents a simple scheduling and jobs experience.
                    </p>

                    <h2>Requirements</h2>
                    <ul>
                        <li>Well.. Proxmox VE</li>
                        <li>NetApp ONTAP NFS (optional SnapMirror relationships for secondary copies).</li>
                        <li>Network access from BareProx to all Proxmox hosts via https and ssh (ports: 443,22)</li>
                        <li>Network access from BareProx to all NetApp Controllers / or SVM:s via https (port: 22)</li>
                        <li>If you plan to replicate to a Secondary NetApp. NFS! access between Proxmox and the Secondary NetApp</li>
                    </ul>

                    <h2>Initial Configuration</h2>
                    <h3>Proxmox Cluster</h3>
                    <ol>
                        <li>Open <strong>Settings → Proxmox</strong> and add your cluster.</li>
                        <li>Use (<code>root@pam</code>).</li>
                        <li>Add hosts, click <strong>Authenticate</strong>, then <strong>Select Storage</strong> to manage.</li>
                    </ol>
                    <p>In the settings for the Proxmox Cluster you can:</p>
                    <ul>
                        <li>Switch between API Tokens and oldschool CSRF for the application authentication to Proxmox.</li>
                        <li>Change the name of the API Token as it appears in Proxmox</li>
                        <li>Set the lifetime of the Token</li>
                        <li>Set the minutes to regenerate the token before it expires.</li>
                    </ul>
                    <h3>NetApp Controllers</h3>
                    <ol>
                        <li>Open <strong>Settings → NetApp</strong> and add a controller or SVM using its management IP/FQDN.</li>
                        <li>Save, then edit the controller to <strong>Select Storage</strong> (volumes) that BareProx should manage.</li>
                        <li>(Optional) Add a secondary controller / SVM if you use SnapMirror replication.</li>
                        <li>If you add a Secondary controller / SVM you also need to select the "destination" volumes</li>
                    </ol>
                    <em>Not. For MetroClusters it is recommended to add the svm:s and not the clusters. That in case of site-switchover.</em>

                    <h3>Optional: SnapMirror</h3>
                    <p>
                        To expose the “Replicate to secondary” option, configure a SnapMirror relationship in ONTAP with
                        a policy that uses case-sensitive labels (for example <code>hourly</code>, <code>daily</code>, <code>weekly</code>).
                        When BareProx detects a valid relationship for a volume, the replication option appears automatically.
                    </p>

                    <h3>Optional: SnapLock / TamperProof Snapshots Primary volumes</h3>
                    <p>To expose the "Enable Locking" option in the backup jobs you need to enable "snapshot-locking-enabled" on the NetApp Volume.
                       This gives you the the possibility to actually lock the snapshots.
                    </p>

                    <h3>Optional: SnapLock / TamperProof Snapshots Secondary volumes</h3>
                    <p>
                        Configure this in the Protection Policy.
                    </p>

                    <h2>Daily Use</h2>
                    <h3>Proxmox Storage View</h3>
                    <ul>
                        <li>Browse discovered storage and VMs grouped by shared NetApp volumes.</li>
                        <li>Use <strong>Backup Now</strong> for an on-demand backup on a selected storage/VM set.</li>
                    </ul>

                    <h3>Schedules</h3>
                    <p>Create recurring backups with retention and optional application-aware options.</p>
                    <ul>
                        <li><strong>Frequency:</strong> hourly / daily / weekly.</li>
                        <li><strong>Retention:</strong> keep N backups per schedule.</li>
                        <li><strong>Application-aware:</strong> I/O freeze, Proxmox snapshot, Include RAM (where supported).</li>
                        <li><strong>Replicate to secondary:</strong> available when SnapMirror policy/labels match.</li>
                    </ul>

                    <h3>Backup Now</h3>
                    <ol>
                        <li>Go to <strong>Proxmox Storage</strong>, select the storage, click <strong>Backup Now</strong>.</li>
                        <li>Choose crash-consistent or app-aware options; optionally enable replication.</li>
                        <li>Start the backup and monitor progress under <strong>Jobs</strong>.</li>
                    </ol>

                    <h3>Snapshots</h3>
                    <ul>
                        <li>View NetApp snapshots per volume (BareProx groups shared storage across hosts).</li>
                        <li><strong>Mount</strong> a snapshot as a FlexClone for testing, validation, or file recovery.</li>
                    </ul>

                    <h3>Restore</h3>
                    <ol>
                        <li>Open <strong>Restore</strong> and pick a backup record or snapshot.</li>
                        <li>Choose target storage, optional new VM name, and whether to remove NICs.</li>
                        <li>Run the restore and follow status in <strong>Jobs</strong>.</li>
                    </ol>

                    <h3>Jobs</h3>
                    <ul>
                        <li>Centralized list of running, completed, failed, or cancelled operations.</li>
                        <li>Open each job for detailed logs; cancel where supported.</li>
                    </ul>

                    <h3>Cleanup</h3>
                    <ul>
                        <li>Use <strong>Settings → Cleanup</strong> to remove orphaned snapshots and stale FlexClones from prior testing/restores.</li>
                    </ul>

                    <h2>Configuration Notes</h2>
                    <h3>Snapshot Locking (Tamper-proof)</h3>
                    <ul>
                        <li>Enable Snapshot Locking on the <em>primary</em> volume in ONTAP to expose locking options in schedules and “Run Now”.</li>
                        <li>Locked snapshots follow ONTAP retention and cannot be deleted until expiry.</li>
                    </ul>

                    <h3>Credentials &amp; Access</h3>
                    <ul>
                        <li><strong>Proxmox:</strong> Prefer API tokens (<code>user@realm!tokenid</code> + secret). Secrets are stored encrypted.</li>
                        <li><strong>NetApp:</strong> Use an ONTAP role that allows snapshot/clone/replication operations required by your workflows.</li>
                        <li><strong>HTTPS:</strong> BareProx serves HTTPS; replace the self-signed certificate if desired.</li>
                    </ul>

                    <h2>Known Limitations</h2>
                    <ul>
                        <li><strong>TPM-restricted guests:</strong> Proxmox snapshot rules may limit app-aware backups for TPM-enabled VMs.</li>
                        <li><strong>Cloud-Init disks:</strong> Often recreated after restore (by design).</li>
                        <li><strong>Exclude VM:</strong> If an exclude list is present in the UI, some flows may still be evolving; verify results in Jobs.</li>
                    </ul>

                    <h2>Troubleshooting</h2>
                    <h3>No storage or VMs appear</h3>
                    <ul>
                        <li>Recheck Proxmox authentication and that hosts were added.</li>
                        <li>Verify the storages you want are selected under <strong>Settings → Proxmox</strong>.</li>
                    </ul>

                    <h3>“Replicate to secondary” missing</h3>
                    <ul>
                        <li>Confirm a SnapMirror relationship exists for the volume.</li>
                        <li>Ensure your ONTAP policy uses the exact case-sensitive labels you selected (e.g., <code>hourly</code>/<code>daily</code>/<code>weekly</code>).</li>
                    </ul>

                    <h3>Snapshot/clone errors</h3>
                    <ul>
                        <li>Check ONTAP role/permissions for the BareProx account and available capacity.</li>
                        <li>Ensure FlexClone licensing/features are available on the ONTAP cluster.</li>
                    </ul>

                    <h3>Where to see logs</h3>
                    <ul>
                        <li>Per-operation logs are visible in <strong>Jobs</strong>.</li>
                        <li>Host/container logs are typically written under <code>/var/bareprox/config/Logs</code>.</li>
                    </ul>

                    <h2>FAQ</h2>
                    <h3>Do I need Proxmox Backup Server?</h3>
                    <p>
                        No. BareProx leverages NetApp volume snapshots/clone semantics behind your existing Proxmox storage
                        and can replicate via SnapMirror. You can still run PBS in parallel if you want image-level backups.
                    </p>

                    <h3>Does BareProx change Proxmox configuration?</h3>
                    <p>
                        BareProx discovers via API and coordinates snapshot/clone operations on the storage side.
                        Storage selection happens in BareProx and ONTAP; Proxmox settings remain under your control.
                    </p>

                    <h3>Can I restore with a new name and without network?</h3>
                    <p>
                        Yes. During restore, set a new name and choose to remove NICs. You can add adapters again after validation.
                    </p>

                    <h2>Support &amp; Diagnostics</h2>
                    <ul>
                        <li>Check <strong>Jobs</strong> and any on-screen <strong>Notifications</strong> for precise errors.</li>
                        <li>Verify credentials and connectivity under <strong>Settings</strong>.</li>
                        <li>Open an issue in the project repository for bugs or feature requests.</li>
                    </ul>

                </article>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const content = document.getElementById('helpContent');
            const tocList = document.getElementById('tocList');
            if (!content || !tocList) return;

            const headings = Array.from(content.querySelectorAll('h2, h3'));
            if (!headings.length) return;

            const slug = s => String(s||'').toLowerCase().replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-');

            headings.forEach(h => { if (!h.id) h.id = slug(h.textContent); });

            const frag = document.createDocumentFragment();
            headings.forEach(h => {
                const li = document.createElement('li');
                if (h.tagName === 'H3') li.classList.add('toc-depth-3');
                const a = document.createElement('a');
                a.href = '#' + h.id;
                a.textContent = h.textContent;
                a.className = 'toc-link';
                li.appendChild(a);
                frag.appendChild(li);
            });
            tocList.innerHTML = '';
            tocList.appendChild(frag);

            if ('IntersectionObserver' in window) {
                const links = Array.from(tocList.querySelectorAll('.toc-link'));
                const io = new IntersectionObserver(entries => {
                    entries.forEach(entry => {
                        const link = links.find(a => a.getAttribute('href') === '#' + entry.target.id);
                        if (!link) return;
                        if (entry.isIntersecting) {
                            links.forEach(a => a.classList.remove('active'));
                            link.classList.add('active');
                        }
                    });
                }, { rootMargin: '-40% 0px -50% 0px', threshold: 0.01 });
                headings.forEach(h => io.observe(h));
            }
        });
    </script>
}
